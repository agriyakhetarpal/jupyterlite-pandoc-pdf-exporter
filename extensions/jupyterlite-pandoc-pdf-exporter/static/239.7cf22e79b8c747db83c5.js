"use strict";(self.webpackChunkjupyterlite_pandoc_pdf_exporter=self.webpackChunkjupyterlite_pandoc_pdf_exporter||[]).push([[239],{239(t,e,s){s.r(e),s.d(e,{default:()=>m});var i=s(595),n=s(602);const a=new class{constructor(){this._isActive=!1,this._message="",this._hideTimeout=null,this._progressChanged=new n.Signal(this),this._activeStateChanged=new n.Signal(this)}get progressChanged(){return this._progressChanged}get activeStateChanged(){return this._activeStateChanged}get isActive(){return this._isActive}get message(){return this._message}start(t){null!==this._hideTimeout&&(clearTimeout(this._hideTimeout),this._hideTimeout=null),this._isActive=!0,this._message=t,this._activeStateChanged.emit(void 0),this._progressChanged.emit(t)}update(t){this._message=t,this._progressChanged.emit(t)}finish(t,e=3e3){this._message=t,this._progressChanged.emit(t),this._hideTimeout=window.setTimeout(()=>{this._isActive=!1,this._message="",this._hideTimeout=null,this._activeStateChanged.emit(void 0)},e)}};let o=null,r=null,d=!1,c=null;class p extends i.BaseExporter{constructor(){super(...arguments),this.mimeType="application/pdf"}async export(t,e){const s=t.content;try{a.start("Preparing PDF export…"),await Promise.all([u(),l()]),a.update("Converting notebook…");const t=function(t){const e=new Map,s=t.cells;let i=0;for(const t of s)if(Array.isArray(t.outputs))for(const s of t.outputs){"update_display_data"===s.output_type&&(s.output_type="display_data");const t=s.data;if(void 0===(null==t?void 0:t["text/latex"]))continue;const n=(Array.isArray(t["text/latex"])?t["text/latex"].join(""):t["text/latex"]).trim(),a=n.match(/^\$\\displaystyle\s*([\s\S]*?)\s*\$$/),o=a?a[1]:n,r="PDFEXPORTER_MATH_"+i++;e.set(r,o),t["text/plain"]=r,delete t["text/latex"]}return e}(s),i={"notebook.ipynb":JSON.stringify(s)},n=await o({from:"ipynb",to:"typst",standalone:!0,"extract-media":".","input-files":["notebook.ipynb"]},null,i);if(n.stderr&&n.stderr.includes("ERROR"))throw new Error(`Pandoc conversion failed: ${n.stderr}`);const r=t.size>0?await async function(t,e){for(const[s,i]of e){let e;try{e=(await o({from:"markdown",to:"typst",standalone:!1},`$$\n${i}\n$$`,{})).stdout.trim()}catch(t){e=`\`\`\`latex\n${i}\n\`\`\``}const n=t.indexOf(s);if(-1===n)continue;let a=t.lastIndexOf("`",n);for(;a>0&&"`"===t[a-1];)a--;const r=n+s.length,d=t.indexOf("`",r);if(-1===d)continue;let c=d;for(;c+1<t.length&&"`"===t[c+1];)c++;t=t.slice(0,a)+e+"\n"+t.slice(c+1)}return t}(n.stdout,t):n.stdout;a.update("Generating PDF…"),$typst.resetShadow();const d=(new TextEncoder).encode(r);if($typst.mapShadow("/main.typ",d),n.mediaFiles)for(const[t,e]of Object.entries(n.mediaFiles)){let s;if(e instanceof Blob)s=new Uint8Array(await e.arrayBuffer());else{if("string"!=typeof e)continue;s=(new TextEncoder).encode(e)}$typst.mapShadow("/"+t,s)}const c=await $typst.pdf({mainFilePath:"/main.typ"});if(!c||0===c.length)throw new Error("Typst produced empty PDF output");!function(t,e){const s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}(new Blob([c.buffer],{type:"application/pdf"}),e.replace(/\.ipynb$/,".pdf")),a.finish("PDF exported successfully")}catch(t){throw a.finish("PDF export failed"),t}}}async function u(){if(!o)return r||(r=(async()=>{const t=await s.e(715).then(s.bind(s,715));o=t.convert})(),r)}async function l(){if(!d||"undefined"==typeof $typst)return c||(c=(async()=>{await s.e(628).then(s.bind(s,628)),await new Promise(t=>{const e=()=>{"undefined"!=typeof $typst?(d=!0,t()):setTimeout(e,100)};e()})})(),c)}var h=s(480),f=s(247);class g extends f.Widget{constructor(){super(),this.node.classList.add("jp-StatusBar-TextItem"),a.progressChanged.connect(this._onProgressChanged,this)}dispose(){this.isDisposed||(a.progressChanged.disconnect(this._onProgressChanged,this),super.dispose())}_onProgressChanged(t,e){this.node.textContent=e}}const y={id:"jupyterlite-pandoc-pdf-exporter:status-bar",description:"A status bar progress indicator for PDF export",autoStart:!0,optional:[h.IStatusBar],activate:(t,e)=>{if(!e)return;const s=new g;e.registerStatusItem("jupyterlite-pandoc-pdf-exporter:status-bar",{item:s,align:"middle",isActive:()=>a.isActive,activeStateChanged:a.activeStateChanged})}},m=[{id:"jupyterlite-pandoc-pdf-exporter:plugin",description:"A PDF exporter for JupyterLite based on WebAssembly distributions of Pandoc and Typst",autoStart:!0,requires:[i.INbConvertExporters],activate:(t,e)=>{e.register("PDF (via Pandoc)",new p)}},y]}}]);